# レコメンドアルゴリズム

## レコメンド条件を設けることで、バックエンド処理をシンプルにする

以下の条件を満たさない場合、レコメンドは行わない：

**「20 曲以上の“いいね”楽曲を持つアーティストを、5 人以上フォローしていること」**

この条件はフロントエンドで制御し、レコメンドリクエスト自体を送信できないようにする。

> **「現在、フォロー中のアーティストの“いいね”曲が少ないため、レコメンドができません。20 曲以上の“いいね”楽曲があるアーティストを、5 人以上フォローしてから再試行してください。」**

この制限によって、**レコメンドに使用されるソース曲数は必ず 100 曲以上**となり、**バックエンド処理がシンプルかつ安定的に実装できる。**

---

## アルゴリズム設計概要

### ステップ

1. SoundCloud API `/me/followings` により、最大 50 人まで取得
2. フォロー中のアーティストを以下の 2 つに分類：
   - `likedTracksCount >= 100` のアーティスト：**通常アーティスト**
   - `20 <= likedTracksCount < 100` のアーティスト：**仮想アーティスト候補**
3. 仮想アーティスト候補を**5 人単位で束ねて仮想アーティスト化**
   - 仮想アーティスト候補をランダムに並び替えてからグループ化することで、レコメンドのランダム性を確保
   - 5 人グループは必ず**合計 100 曲以上**のグループとなるため、仮想アーティストとして扱う
   - 5 人に満たない端数グループについても、**合計 100 曲以上の楽曲がある場合は仮想アーティストとする**。それ未満は切り捨て
4. 通常アーティスト + 仮想アーティストの中から、ランダムで 1 つ選出
5. 選ばれたアーティストのいいね楽曲を取得：

   #### 通常アーティストの場合：

   - 最大 **6 ページ**（= 最大 300 曲）まで `next_href` をたどる（最大 6 リクエスト）

   #### 仮想アーティストの場合：

   - 各構成アーティストから **1 ページ（最大 50 曲）** を取得
   - 合計で **100〜250 曲** 程度のソースが得られる（最大 5 リクエスト）

6. 収集した楽曲から **10 曲をランダムに選出してレコメンド**

---

## 工夫した点・難しかった点

- レコメンドソースとなる曲数を **100〜300 曲用意し、その中から 10 曲をランダムに選ぶ**ことで、自然なばらつきを実現
- 「1 人のアーティストを深掘りする」戦略を中心に据えることで、**古い“いいね”曲や埋もれた名曲が選ばれやすくなり、アプリの“ディグ体験”というテーマにマッチさせた**
- ランダム性、API 通信回数、そしてテーマ性をどう両立するかに苦労したが、**最大通信数を 6 回程度に抑える設計とすることで、2〜5 秒のレスポンスを可能とした**
- フロントエンドで条件を満たすユーザーのみにレコメンドを許可することで、**バックエンド側のロジックを単純化し、安定かつ要件を満たしたレコメンドを実現できた**
- 当初は API ポリシーを意識して「複数アーティストをソースにする」ことにこだわっていたが、**最終的には 1 人のアーティストでも、出典を明示せず、5 人以上のフォロー制限を設けることで、再配信とみなされない構成を実現した**
